# Implementation Plan: PDF Download Analytics Dashboard

**Branch**: `001-create-a-simple` | **Date**: 2025-01-13 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `specs/001-create-a-simple/spec.md`

**Note**: This document is generated by `/speckit.plan` and guides the implementation workflow.

## Summary

Build an analytics dashboard to track PDF download activity from the existing PDF Merger API. The dashboard will record every download attempt, categorize by HTTP status code, identify most accessed URLs, and track error patterns. Features include secure token-based authentication, dual-interface design (web dashboard + API endpoints), and persistent storage of analytics data.

Primary value: Operational visibility into PDF merge service usage and reliability.

## Technical Context

**Language/Version**: TypeScript 5.7+ (existing project uses TypeScript with strict mode)
**Primary Dependencies**:
- Express 4.21+ (existing HTTP server)
- Prisma ORM with SQLite driver (for analytics persistence)
- React 18+ with Vite 5+ (web dashboard frontend)
- pdf-lib 1.17+ (existing PDF operations)

**Storage**: SQLite database via Prisma ORM for analytics data persistence
**Testing**: Manual testing recommended (constitution allows optional tests); potential for integration tests if time permits
**Target Platform**: Node.js >=20 and Bun 1.0+ (per constitution's runtime compatibility requirement)
**Project Type**: Web application (backend API + frontend dashboard)
**Performance Goals**:
- < 50ms analytics recording latency (p95)
- < 5 second dashboard load time
- Support 1,000 concurrent download tracking operations
**Constraints**:
- Must not impact existing PDF merge API performance
- Analytics recording must be non-blocking
- Authentication via simple API_TOKEN in .env (no complex user management)
**Scale/Scope**:
- Support up to 100,000 recorded download events without degradation
- Low concurrent dashboard users (< 10 administrators)
- Single-tenant deployment (no multi-tenancy required)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Reference: `.specify/memory/constitution.md`

**Dual-Interface Design**
- [⚠] Feature accessible via both HTTP API and CLI (or infeasibility justified)
  - **VIOLATION**: Dashboard is inherently visual (web UI). CLI interface for analytics queries is feasible but may not provide equivalent value to visual dashboard.
  - **JUSTIFICATION**: Will provide API endpoints for programmatic analytics access. CLI wrapper for these APIs can be added if needed, but primary value is visual dashboard for administrators.
- [✓] Both interfaces share same underlying implementation
  - Analytics service layer will be shared between web dashboard and API endpoints
- [✓] Error handling consistent across interfaces
  - All interfaces will use common error handling patterns

**Runtime Compatibility**
- [✓] Code runs on both Bun and Node.js (>=20)
  - Prisma, Express, and React/Vite all compatible with both runtimes
- [✓] No runtime-specific APIs without compatibility layer
  - Using standard libraries with cross-runtime support
- [✓] Testing plan includes both runtimes for critical paths
  - Analytics recording should be tested on both Bun and Node.js

**Error Resilience**
- [✓] Partial success preferred over complete failure
  - Analytics recording failures will log errors but not block PDF operations
- [✓] Errors logged with sufficient context
  - Will implement comprehensive error logging for analytics operations
- [✓] Operations return best-effort results
  - Dashboard will display available data even if some queries fail

**Code Quality**
- [✓] Biome linting configuration followed
  - Existing Biome configuration will apply to new code
- [✓] TypeScript strict mode enabled
  - Project already uses strict mode
- [✓] Semantic commit convention documented
  - Will follow existing semantic-release conventions

**Semantic Versioning**
- [✓] Version impact documented (MAJOR/MINOR/PATCH)
  - This is a MINOR version bump (new feature, backward compatible)
- [✓] Breaking changes flagged with `!` if applicable
  - No breaking changes to existing API

**Simplicity**
- [✓] No unnecessary abstractions
  - Simple service layer, direct Prisma queries, minimal middleware
- [✓] YAGNI principle applied
  - Building only requested features, no speculative additions
- [✓] Complexity justified if required
  - Prisma adds complexity but justified for type-safe database access

## Project Structure

### Documentation (this feature)

```
specs/001-create-a-simple/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Technology decisions and patterns
├── data-model.md        # Database schema and entities
├── quickstart.md        # Development and deployment guide
└── contracts/           # API endpoint specifications
    ├── analytics-api.yaml
    └── dashboard-auth.yaml
```

### Source Code (repository root)

```
# Existing + New Backend Structure (all in src/)
src/
├── index.ts                    # Main Express server (modify to add analytics routes)
├── pdf-merger.ts               # Existing PDF operations (modify to record analytics)
├── merge-cli.ts                # Existing CLI tool
├── utils.ts                    # Existing utilities
│
├── analytics/                  # New analytics backend
│   ├── service.ts              # Analytics recording and query service
│   ├── prisma-client.ts        # Prisma client singleton
│   └── middleware.ts           # Express middleware for analytics tracking
│
├── dashboard/                  # New dashboard backend
│   ├── auth-middleware.ts      # Token authentication middleware
│   └── routes.ts               # Dashboard API routes
│
└── dashboard-ui/               # New React dashboard (nested in src/)
    ├── src/
    │   ├── App.tsx             # Main dashboard component
    │   ├── components/
    │   │   ├── StatsOverview.tsx
    │   │   ├── TopUrls.tsx
    │   │   ├── ErrorTracking.tsx
    │   │   └── AuthGuard.tsx
    │   ├── services/
    │   │   ├── api.ts          # API client for analytics endpoints
    │   │   └── auth.ts         # Authentication service
    │   └── main.tsx            # Vite entry point
    ├── index.html
    ├── vite.config.ts
    ├── tsconfig.json
    └── package.json

# Prisma schema (conventional location outside src/)
prisma/
├── schema.prisma               # Database schema
├── analytics.db                # SQLite database (gitignored)
└── migrations/                 # Schema migrations

# Tests (optional per constitution)
tests/
├── integration/
│   └── analytics.test.ts
└── contract/
    └── dashboard-api.test.ts

# Build output
dist/
├── index.js                    # Compiled backend
├── analytics/
├── dashboard/
└── dashboard-ui/dist/          # Vite build output (served by Express)
```

**Structure Decision**: All application code lives in `src/` directory per project convention. Frontend dashboard is at `src/dashboard-ui/` (not root-level `dashboard/`). Prisma schema remains at `prisma/` following ORM conventions. This maintains consistency with existing project structure while keeping everything organized under `src/`.

## Complexity Tracking

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| CLI interface for dashboard | Dashboard is inherently visual; primary value is graphical analytics display | Text-based CLI analytics would be difficult to interpret for trend visualization; JSON output from API endpoints provides programmatic access |
| Prisma ORM adds dependency | Type-safe database access, migration management, and cross-runtime compatibility | Raw SQL queries lack type safety and require manual migration management; Prisma provides excellent TypeScript integration |
| Separate frontend build (React/Vite) | Rich interactive dashboard requires modern frontend framework | Server-side rendered HTML templates insufficient for dynamic charts and real-time updates; React provides component reusability |

## Phase 0: Research & Decisions

See [research.md](research.md) for detailed technology research and architectural decisions.

**Key Decisions**:
1. **ORM Selection**: Prisma chosen for type-safe database access and cross-runtime support
2. **Database**: SQLite for simplicity; easy migration to PostgreSQL if needed
3. **Frontend Framework**: React with Vite for fast development and optimal build output
4. **Authentication**: Token-based via environment variable (simple, secure enough for admin tool)
5. **Analytics Recording**: Middleware pattern in Express to capture download attempts non-blocking
6. **API Design**: RESTful endpoints for analytics queries following existing Express patterns

## Phase 1: Design Artifacts

### Data Model
See [data-model.md](data-model.md) for complete database schema.

**Primary Entities**:
- `DownloadEvent`: Records each PDF download attempt
- `UrlStats`: Aggregated statistics per URL (computed view or materialized)

### API Contracts
See [contracts/](contracts/) directory for OpenAPI specifications.

**Dashboard API Endpoints**:
- `GET /api/analytics/overview` - Status code summary
- `GET /api/analytics/top-urls` - Most accessed URLs
- `GET /api/analytics/errors` - Error tracking statistics
- `POST /api/analytics/event` - Record download event (internal use)

**Authentication**:
- All dashboard endpoints require `X-API-Token` header
- Token validation against `ANALYTICS_API_TOKEN` environment variable

### Quickstart Guide
See [quickstart.md](quickstart.md) for development setup and deployment instructions.

## Implementation Notes

**Integration Points**:
1. Modify `src/index.ts` to add analytics middleware
2. Modify `src/pdf-merger.ts` or response handlers to record download events
3. Add new environment variable `ANALYTICS_API_TOKEN` to `.env`
4. Serve React dashboard static files from Express

**Database Considerations**:
- SQLite file location: `prisma/analytics.db` (excluded from git)
- Migrations managed via `npx prisma migrate`
- Consider adding database backup strategy in production

**Frontend Deployment**:
- Vite builds to `dashboard/dist`
- Express serves static files from this directory
- Production build integrated into main Docker image

**Testing Strategy** (optional):
- Manual testing of analytics recording during PDF operations
- Integration tests for API endpoints
- Frontend component testing if time permits

**Version Impact**: MINOR (new feature, backward compatible)
- Commit prefix: `feat:`
- No breaking changes to existing PDF merge API
- New optional analytics feature
